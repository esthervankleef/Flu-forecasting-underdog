rm(list=ls())

library(tidyverse)

####################################################################
### create a sample time series with seasonality and noise
t.idx <- 1:(52*10) # our time variable, equivalent to 10 years of weekly data

demo.ts <- sin(3.5 + t.idx * (2 * pi)/52) # simulate a seasonal curve
demo.ts <- demo.ts + 0.002 * t.idx # add a trend
demo.ts <- rnorm(length(t.idx), demo.ts, 1) # add noise
demo.ts <- exp(demo.ts + 3) # increase number and add skewing

plot(demo.ts, type='l')

####################################################################
### additional data
# index of Google searches in Norway for "camping"
# from https://www.google.com/trends/correlate/
camping.norway <- c(-0.355, -0.228, -0.295, -0.229, -0.184, -0.29, -0.37, -0.542, 
-0.496, -0.51, -0.458, -0.457, -0.336, -0.292, -0.235, -0.225, 
-0.189, 0.012, -0.194, 0.395, 0.336, 0.426, 0.573, 0.739, 0.856, 
1.631, 1.721, 1.737, 1.255, 1.037, 0.298, 0.215, -0.217, -0.4, 
-0.537, -0.648, -0.558, -0.652, -0.648, -0.747, -0.795, -0.761, 
-0.79, -0.827, -0.802, -0.828, -0.843, -0.803, -0.849, -0.811, 
-0.857, -0.78, -0.742, -0.672, -0.596, -0.601, -0.527, -0.622, 
-0.58, -0.557, -0.587, -0.438, -0.436, -0.372, -0.293, -0.341, 
-0.236, -0.254, -0.279, -0.112, -0.105, -0.008, 0.028, 0.244, 
0.485, 0.518, 1.179, 1.463, 1.924, 2.067, 1.434, 1.236, 0.545, 
-0.037, -0.207, -0.449, -0.514, -0.57, -0.611, -0.674, -0.734, 
-0.689, -0.76, -0.793, -0.804, -0.838, -0.825, -0.765, -0.818, 
-0.845, -0.841, -0.815, -0.835, -0.725, -0.667, -0.626, -0.585, 
-0.641, -0.674, -0.59, -0.612, -0.525, -0.579, -0.479, -0.478, 
-0.482, -0.389, -0.362, -0.248, -0.129, -0.13, 0.037, 0.07, 0.075, 
0.202, 0.329, 0.461, 0.792, 1.076, 1.735, 2.202, 2.371, 2.09, 
1.451, 0.811, 0.357, -0.117, -0.295, -0.483, -0.469, -0.598, 
-0.62, -0.659, -0.637, -0.703, -0.757, -0.762, -0.744, -0.787, 
-0.811, -0.805, -0.794, -0.824, -0.82, -0.834, -0.793, -0.628, 
-0.602, -0.604, -0.629, -0.61, -0.615, -0.589, -0.538, -0.525, 
-0.485, -0.462, -0.427, -0.277, -0.22, -0.106, -0.14, -0.108, 
0.01, 0.002, 0.09, 0.246, 0.382, 0.695, 0.862, 1.253, 1.686, 
2.091, 2.2, 2.006, 1.504, 0.88, 0.387, -0.049, -0.205, -0.37, 
-0.429, -0.517, -0.582, -0.637, -0.616, -0.666, -0.68, -0.719, 
-0.72, -0.787, -0.788, -0.789, -0.801, -0.795, -0.821, -0.822, 
-0.702, -0.616, -0.573, -0.563, -0.542, -0.544, -0.534, -0.488, 
-0.43, -0.486, -0.449, -0.369, -0.26, -0.285, -0.317, -0.264, 
-0.221, -0.068, 0.075, 0.156, 0.114, 0.236, 0.435, 0.791, 0.862, 
1.183, 1.716, 2.289, 2.649, 2.447, 2.166, 1.291, 0.553, 0.119, 
-0.158, -0.294, -0.393, -0.485, -0.513, -0.612, -0.622, -0.652, 
-0.731, -0.716, -0.758, -0.778, -0.759, -0.789, -0.818, -0.824, 
-0.828, -0.803, -0.732, -0.611, -0.622, -0.56, -0.564, -0.532, 
-0.562, -0.578, -0.492, -0.534, -0.391, -0.374, -0.352, -0.333, 
-0.173, -0.058, -0.033, 0.007, 0.096, 0.141, 0.019, 0.489, 0.683, 
0.853, 1.01, 1.315, 2.014, 2.657, 3.012, 3.063, 2.477, 1.623, 
0.985, 0.299, -0.09, -0.274, -0.372, -0.437, -0.47, -0.533, -0.573, 
-0.646, -0.673, -0.702, -0.714, -0.724, -0.753, -0.761, -0.758, 
-0.784, -0.759, -0.797, -0.767, -0.655, -0.652, -0.593, -0.546, 
-0.538, -0.539, -0.479, -0.509, -0.502, -0.412, -0.422, -0.387, 
-0.28, -0.129, -0.117, -0.151, -0.141, -0.028, 0.076, 0.196, 
0.32, 0.45, 0.589, 0.823, 1.146, 1.733, 2.447, 2.953, 3.286, 
3.116, 2.074, 1.195, 0.561, 0.124, -0.138, -0.276, -0.429, -0.476, 
-0.529, -0.593, -0.587, -0.65, -0.718, -0.725, -0.735, -0.744, 
-0.748, -0.803, -0.804, -0.813, -0.81, -0.806, -0.631, -0.574, 
-0.563, -0.543, -0.501, -0.526, -0.498, -0.516, -0.467, -0.473, 
-0.438, -0.395, -0.334, -0.299, -0.223, -0.13, 0.201, 0.059, 
0.1, 0.144, 0.623, 0.719, 0.758, 0.938, 1.269, 1.628, 2.427, 
3.016, 3.345, 2.57, 1.986, 1.511, 0.716, 0.229, -0.073, -0.229, 
-0.324, -0.389, -0.465, -0.493, -0.499, -0.568, -0.501, -0.639, 
-0.676, -0.703, -0.718, -0.759, -0.756, -0.786, -0.794, -0.803, 
-0.638, -0.617, -0.566, -0.558, -0.555, -0.522, -0.545, -0.533, 
-0.431, -0.427, -0.397, -0.353, -0.356, -0.209, -0.085, -0.118, 
-0.186, -0.07, 0.015, -0.006, 0.089, 0.546, 0.569, 0.657, 0.971, 
1.334, 1.991, 2.569, 3.147, 3.319, 2.458, 1.423, 0.828, 0.319, 
0.002, -0.183, -0.271, -0.365, -0.448, -0.497, -0.504, -0.571, 
-0.659, -0.669, -0.717, -0.717, -0.738, -0.752, -0.769, -0.765, 
-0.731, -0.859, -0.906, -0.862, -0.679, -0.552, -0.51, -0.526, 
-0.505, -0.505, -0.465, -0.472, -0.42, -0.425, -0.383, -0.176, 
-0.239, -0.285, -0.241, -0.182, -0.034, 0.187, 0.215, 0.521, 
0.471, 0.787, 0.946, 1.403, 1.982, 2.768, 3.681, 3.901, 2.886, 
1.825, 0.989, 0.312, 0.027, -0.166, -0.293, -0.397, -0.443, -0.509, 
-0.486, -0.599, -0.65, -0.699, -0.712, -0.722, -0.737, -0.747, 
-0.782, -0.787, -0.792, -0.803)


####################################################################
### ARIMA model
ccf(camping.norway, demo.ts)
my.lag <- 8 # picked from ccf()

# identify maximum time for data to use to fit model
train.time <- 52*5 + 20 # 5 years of data plus 3 weeks

# log transform data
log.demo.ts <- log(demo.ts + 1)

# limit data to data available at train.time
log.demo.ts <- log.demo.ts[1:train.time]
camping.norway <- camping.norway[1:train.time]

# fit model on log transformed data
model <- arima(log.demo.ts[(1 + my.lag):train.time], order=c(1, 0, 0),
    seasonal=list(order=c(1, 0, 0), period=52),
    xreg=camping.norway[1:(train.time - my.lag)], method="CSS")

# capture model fit for plotting
model.fit <- predict(model, newxreg=camping.norway[1:(train.time - my.lag)])
model.fit <- data_frame(
    pred=as.numeric(model.fit$pred), 
    se=rep(model.fit$se, length(model.fit$pred))) %>%
  mutate(
    t.idx = (1 + my.lag):train.time,
    point.pred = exp(pred) - 1,
    lwr95.pred = exp(pred - qnorm(0.975) * se) - 1,
    upr95.pred = exp(pred + qnorm(0.975) * se) - 1
  )

####################################################################
### forecast
# WARNING - DO NOT try to forecast longer than your lag
# (you can make shorter forecasts though)
forecast.wks.ahead <- my.lag
forecast <- predict(model, n.ahead=forecast.wks.ahead, 
    newxreg=camping.norway[train.time - my.lag + 1:forecast.wks.ahead])

### calculate mean predictions and 95% CIs
forecast <- as.data.frame(forecast) %>%
  mutate(
    t.idx = train.time + 1:forecast.wks.ahead,
    point.pred = exp(pred) - 1,
    lwr95.pred = exp(pred - qnorm(0.975) * se) - 1,
    upr95.pred = exp(pred + qnorm(0.975) * se) - 1
  )
forecast

####################################################################
### plot data and forecast
plot(t.idx[1:max(forecast$t.idx)], demo.ts[1:max(forecast$t.idx)], 
    pch=19, cex=0.25,
    xlab="date", ylab="cases")
polygon(x=c(model.fit$t.idx, rev(model.fit$t.idx)),
        y=c(model.fit$upr95.pred, rev(model.fit$lwr95.pred)), 
        col=adjustcolor('darkblue', 0.25), border=F)
lines(model.fit$t.idx, model.fit$point.pred, 
    col=adjustcolor('darkblue', 0.5), lwd=3)
polygon(x=c(forecast$t.idx, rev(forecast$t.idx)),
        y=c(forecast$upr95.pred, rev(forecast$lwr95.pred)), 
        col=adjustcolor('darkred', 0.25), border=F)
lines(forecast$t.idx, forecast$point.pred, 
    col=adjustcolor('darkred', 0.5), lwd=3)


